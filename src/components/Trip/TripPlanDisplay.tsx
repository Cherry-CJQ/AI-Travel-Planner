import React, { useState } from 'react'
import {
  Card,
  Timeline,
  Statistic,
  Row,
  Col,
  Tag,
  Button,
  Space,
  Divider,
  Typography,
  Progress,
  Tabs
} from 'antd'
import {
  EnvironmentOutlined,
  ClockCircleOutlined,
  DollarOutlined,
  SaveOutlined,
  ShareAltOutlined,
  CompassOutlined,
  UnorderedListOutlined
} from '@ant-design/icons'
import { TripGenerationResponse } from '../../types/database'
import { useTripStore } from '../../stores/tripStore'
import { TripMap } from '../Map/TripMap'

const { Title, Text, Paragraph } = Typography
const { TabPane } = Tabs

interface TripPlanDisplayProps {
  plan: TripGenerationResponse
  onSave?: () => void
  onShare?: () => void
}

export const TripPlanDisplay: React.FC<TripPlanDisplayProps> = ({
  plan,
  onSave,
  onShare
}) => {
  const { saveGeneratedTrip, loading } = useTripStore()
  const [activeTab, setActiveTab] = useState('details')

  const handleSave = async () => {
    try {
      await saveGeneratedTrip()
      onSave?.()
    } catch (error) {
      console.error('‰øùÂ≠òË°åÁ®ãÂ§±Ë¥•:', error)
    }
  }

  const getActivityIcon = (type: string) => {
    const icons: Record<string, string> = {
      TRANSPORT: 'üöó',
      ACCOMMODATION: 'üè®',
      FOOD: 'üçΩÔ∏è',
      SIGHTSEEING: 'üèõÔ∏è',
      SHOPPING: 'üõçÔ∏è',
      OTHER: 'üìù'
    }
    return icons[type] || 'üìç'
  }

  const getActivityColor = (type: string) => {
    const colors: Record<string, string> = {
      TRANSPORT: 'blue',
      ACCOMMODATION: 'green',
      FOOD: 'orange',
      SIGHTSEEING: 'purple',
      SHOPPING: 'pink',
      OTHER: 'default'
    }
    return colors[type] || 'default'
  }

  const totalBudget = Object.values(plan.budgetBreakdown).reduce((sum, amount) => sum + (amount || 0), 0)

  // ÊèêÂèñÊâÄÊúâÊ¥ªÂä®
  const allActivities = plan.dailyPlan.flatMap(dayPlan => dayPlan.activities)

  // Ë°åÁ®ãËØ¶ÊÉÖÂÜÖÂÆπ
  const detailsContent = (
    <div>
      {/* È¢ÑÁÆóÂàÜËß£ */}
      <Card title="È¢ÑÁÆóÂàÜËß£" style={{ marginBottom: 24 }}>
        <Row gutter={16}>
          <Col span={8}>
            <Statistic
              title="ÊÄªÈ¢ÑÁÆó"
              value={totalBudget}
              prefix="¬•"
              valueStyle={{ color: '#3f8600' }}
            />
          </Col>
          <Col span={16}>
            <div style={{ marginBottom: 16 }}>
              {Object.entries(plan.budgetBreakdown).map(([category, amount]) => {
                if (!amount) return null
                const percentage = (amount / totalBudget) * 100
                return (
                  <div key={category} style={{ marginBottom: 12 }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: 4 }}>
                      <Text>
                        {category === 'flights' && 'Êú∫Á•®'}
                        {category === 'accommodation' && '‰ΩèÂÆø'}
                        {category === 'food' && 'È§êÈ•Æ'}
                        {category === 'transportation' && '‰∫§ÈÄö'}
                        {category === 'activities' && 'Ê¥ªÂä®'}
                        {category === 'shopping' && 'Ë¥≠Áâ©'}
                        {category === 'other' && 'ÂÖ∂‰ªñ'}
                      </Text>
                      <Text strong>¬•{amount.toLocaleString()}</Text>
                    </div>
                    <Progress 
                      percent={Math.round(percentage)} 
                      size="small" 
                      showInfo={false}
                    />
                  </div>
                )
              })}
            </div>
          </Col>
        </Row>
      </Card>

      {/* ÊØèÊó•ËÆ°Âàí */}
      <Card title="ÊØèÊó•Ë°åÁ®ãÂÆâÊéí">
        {plan.dailyPlan.map((dayPlan, dayIndex) => (
          <div key={dayIndex} style={{ marginBottom: 32 }}>
            <Divider orientation="left">
              <Title level={4} style={{ margin: 0 }}>
                Á¨¨{dayPlan.day}Â§© - {dayPlan.theme}
              </Title>
            </Divider>
            
            <Timeline>
              {dayPlan.activities.map((activity, activityIndex) => (
                <Timeline.Item
                  key={activityIndex}
                  dot={
                    <span style={{ fontSize: '16px' }}>
                      {getActivityIcon(activity.type)}
                    </span>
                  }
                >
                  <Card 
                    size="small" 
                    style={{ marginBottom: 8 }}
                    bodyStyle={{ padding: '12px 16px' }}
                  >
                    <Row gutter={16} align="middle">
                      <Col span={3}>
                        <Text strong style={{ fontSize: '16px' }}>
                          {activity.time}
                        </Text>
                      </Col>
                      <Col span={15}>
                        <div>
                          <Text strong style={{ fontSize: '16px' }}>
                            {activity.name}
                          </Text>
                          {activity.cost && (
                            <Text style={{ marginLeft: 8, color: '#52c41a' }}>
                              ¬•{activity.cost}
                            </Text>
                          )}
                        </div>
                        <Paragraph 
                          type="secondary" 
                          style={{ margin: '4px 0 0 0', fontSize: '14px' }}
                        >
                          {activity.description}
                        </Paragraph>
                        {activity.location && (
                          <Text type="secondary" style={{ fontSize: '12px' }}>
                            <EnvironmentOutlined /> ‰ΩçÁΩÆ‰ø°ÊÅØ
                          </Text>
                        )}
                      </Col>
                      <Col span={6} style={{ textAlign: 'right' }}>
                        <Tag color={getActivityColor(activity.type)}>
                          {activity.type === 'TRANSPORT' && '‰∫§ÈÄö'}
                          {activity.type === 'ACCOMMODATION' && '‰ΩèÂÆø'}
                          {activity.type === 'FOOD' && 'È§êÈ•Æ'}
                          {activity.type === 'SIGHTSEEING' && 'ËßÇÂÖâ'}
                          {activity.type === 'SHOPPING' && 'Ë¥≠Áâ©'}
                          {activity.type === 'OTHER' && 'ÂÖ∂‰ªñ'}
                        </Tag>
                      </Col>
                    </Row>
                  </Card>
                </Timeline.Item>
              ))}
            </Timeline>
          </div>
        ))}
      </Card>
    </div>
  )

  // Âú∞ÂõæÂÜÖÂÆπ
  const mapContent = (
    <div>
      <TripMap
        destination={plan.tripSummary.destination}
        activities={allActivities}
        height={500}
        onLocationClick={(location) => {
          console.log('ÁÇπÂáª‰ΩçÁΩÆ:', location)
        }}
      />
      
      {/* Ê¥ªÂä®ÁªüËÆ° */}
      <Card title="Ê¥ªÂä®ÁªüËÆ°" style={{ marginTop: 24 }}>
        <Row gutter={16}>
          <Col span={8}>
            <Statistic
              title="ÊÄªÊ¥ªÂä®Êï∞"
              value={allActivities.length}
              prefix="üìù"
            />
          </Col>
          <Col span={8}>
            <Statistic
              title="Ë°åÁ®ãÂ§©Êï∞"
              value={plan.tripSummary.duration}
              prefix="üìÖ"
            />
          </Col>
          <Col span={8}>
            <Statistic
              title="ÁõÆÁöÑÂú∞"
              value={plan.tripSummary.destination}
              valueStyle={{ fontSize: '16px' }}
            />
          </Col>
        </Row>
      </Card>
    </div>
  )

  return (
    <div style={{ maxWidth: 1200, margin: '0 auto' }}>
      {/* Ë°åÁ®ãÊ¶ÇËßà */}
      <Card style={{ marginBottom: 24 }}>
        <Row gutter={16} align="middle">
          <Col span={16}>
            <Title level={2} style={{ margin: 0 }}>
              {plan.tripSummary.title}
            </Title>
            <Space size="middle" style={{ marginTop: 8 }}>
              <Text>
                <EnvironmentOutlined /> {plan.tripSummary.destination}
              </Text>
              <Text>
                <ClockCircleOutlined /> {plan.tripSummary.duration}Â§©
              </Text>
              <Text>
                <DollarOutlined /> ÊÄªÈ¢ÑÁÆó: ¬•{plan.tripSummary.estimatedTotalCost.toLocaleString()}
              </Text>
            </Space>
          </Col>
          <Col span={8} style={{ textAlign: 'right' }}>
            <Space>
              <Button 
                type="primary" 
                icon={<SaveOutlined />}
                loading={loading}
                onClick={handleSave}
              >
                ‰øùÂ≠òË°åÁ®ã
              </Button>
              <Button icon={<ShareAltOutlined />} onClick={onShare}>
                ÂàÜ‰∫´
              </Button>
            </Space>
          </Col>
        </Row>
      </Card>

      {/* Ê†áÁ≠æÈ°µ */}
      <Tabs
        activeKey={activeTab}
        onChange={setActiveTab}
        items={[
          {
            key: 'details',
            label: (
              <span>
                <UnorderedListOutlined />
                Ë°åÁ®ãËØ¶ÊÉÖ
              </span>
            ),
            children: detailsContent
          },
          {
            key: 'map',
            label: (
              <span>
                <CompassOutlined />
                Ë°åÁ®ãÂú∞Âõæ
              </span>
            ),
            children: mapContent
          }
        ]}
      />

      {/* Êìç‰ΩúÊåâÈíÆ */}
      <div style={{ textAlign: 'center', marginTop: 24 }}>
        <Space>
          <Button 
            type="primary" 
            size="large"
            icon={<SaveOutlined />}
            loading={loading}
            onClick={handleSave}
          >
            ‰øùÂ≠òÊ≠§Ë°åÁ®ã
          </Button>
          <Button size="large" icon={<ShareAltOutlined />} onClick={onShare}>
            ÂàÜ‰∫´Ë°åÁ®ã
          </Button>
        </Space>
      </div>
    </div>
  )
}